---
title: "H_Simulation_Analysis"
author: "Tyler M. Wiles"
date: "2025-11-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Description

Words

# Simulation

Analysis of data obtained from our simulations

## Libraries and Data Management

```{r Libraries and Data Management}

options(scipen = 999)
rm(list=ls())

library(BayesFactor)
library(bayestestR)
library(data.table)
library(here)
library(ggplot2)
library(ggridges)

files = list.files(path = here::here('DATA', 'H_Simulation'), pattern = "^H_Simulation[0-9]+(_[0-9]+)?\\.csv$", full.names = TRUE)
dat = rbindlist(lapply(files, data.table::fread))
dat = dat[ ,-1]

setnames(dat, old = c('h.original', 'h.test.random', 'h.test.contiguous'),
         new = c('original', 'random', 'contiguous'))

dat$random.diff = dat$random - dat$original
dat$contiguous.diff = dat$contiguous - dat$original

dat.long = melt(dat,
                measure.vars = tail(names(dat), 5),
                variable.name = "data.version",
                value.name   = "h.value")

dat.long$drops = dat.long$drops * 100 # Change to percent

# Factors
dat.long$stride.intervals = factor(dat.long$stride.intervals)
dat.long$drops = factor(dat.long$drops)
dat.long$stride.intervals.cut = factor(dat.long$stride.intervals.cut)
dat.long$stride.intervals.new.length = factor(dat.long$stride.intervals.new.length)
dat.long$h.target = factor(dat.long$h.target, levels = rev(levels(factor(dat.long$h.target))))
dat.long$data.version = factor(dat.long$data.version)

dat.long$h.value.abs = abs(dat.long$h.value)

```

## BFTests

Using Bayesian ttests, is H obtained from the dropped time series different from zero?

```{r BFTests}

# Easier to see/compare results with the differences rather than raw values
dat.long.temp = dat.long[!(dat.long$data.version %in% c('original', 'random', 'contiguous')), ]

bf.abs = dat.long.temp %>%
  group_by(h.target, stride.intervals, drops, data.version) %>%
  summarise(mu = mean(h.value.abs),
            ci.lower = bayestestR::ci(h.value.abs, method = 'hdi', ci = 0.95)$CI_low,
            ci.upper = bayestestR::ci(h.value.abs, method = 'hdi', ci = 0.95)$CI_high,
            BF10 = BayesFactor::extractBF(BayesFactor::ttestBF(x = h.value.abs, mu = 0))$bf,
            .groups = "drop")

bf.rel = dat.long.temp %>%
  group_by(h.target, stride.intervals, drops, data.version) %>%
  summarise(mu = mean(h.value),
            ci.lower = bayestestR::ci(h.value, method = 'hdi', ci = 0.95)$CI_low,
            ci.upper = bayestestR::ci(h.value, method = 'hdi', ci = 0.95)$CI_high,
            BF10 = BayesFactor::extractBF(BayesFactor::ttestBF(x = h.value, mu = 0))$bf,
            .groups = "drop")

# How many of those are dependent on H?
table(bf.abs$h.target[bf.abs$BF10 > 1])
table(bf.rel$h.target[bf.rel$BF10 > 1])

```

## Plots

### Absolute

```{r Absolute}

# Easier to see/compare results with the differences rather than raw values
dat.long.temp = dat.long[!(dat.long$data.version %in% c('original', 'random', 'contiguous')), ]

ci95 = dat.long.temp |>
  dplyr::group_by(data.version, h.target, stride.intervals, drops) |>
  dplyr::summarise(h.mean = mean(h.value.abs, na.rm = TRUE),
                   h.median = median(h.value.abs, na.rm = TRUE),
                   .groups = "drop")

# Define line types that get more dashed with larger drops
linetypes = c("solid", "88", "66", "44", "22", "11")
linetype_map = setNames(rep(linetypes, length.out = length(unique(dat.long.temp$drops))),
                        sort(unique(dat.long.temp$drops)))

plot.sim.abs = ggplot(dat.long.temp, aes(x = h.value.abs, fill = data.version)) +
  # Beautifying
  theme_classic() +
  scale_x_continuous(limits = c(0, 0.15),
                     breaks = c(0, 0.05, 0.10, 0.15)) +
  # Raw data
  geom_density(alpha = 0.3, adjust = 1, show.legend = TRUE) +
  # Mean lines with varying dash intensity by drops
  geom_vline(data = ci95, aes(xintercept = h.mean,
                              color = data.version,
                              linetype = factor(drops)),
             linewidth = 0.6,
             show.legend = TRUE) +
  scale_linetype_manual(values = linetype_map,
                        name = "Dropped Data (%)") +
  # More beautifying
  scale_fill_manual(values = c("random.diff" = scales::alpha("#FA4616", 0.1),
                               "contiguous.diff" = scales::alpha("#0021A5", 0.1)),
                    name = "Data Version",
                    labels = c("Random", "Contiguous")) +
  scale_color_manual(values = c("random.diff" = "#FA4616",
                                "contiguous.diff" = "#0021A5"),
                     guide = "none") +
  labs(title = "Simulation",
       x = "Absolute Difference from Original Hurst Exponent (Dropped - Original)",
       y = "Density") +
  facet_grid(rows = vars(h.target),
             cols = vars(stride.intervals),
             labeller = labeller(h.target = function(x) paste0("H = ", x),
                                 stride.intervals = function(x) paste0(x, " Stride Intervals")),
             axes = "all_x") +
  theme(legend.position = "top",
        text = element_text(size = 9),
        axis.text.x = element_text(size = 7, angle = 30, hjust = 1),
        axis.text.y = element_text(size = 7),
        plot.title = element_text(hjust = 0.5, face = "bold", size = 15))

ggsave(filename = 'C:/Users/twiles/Downloads/sim_abs.jpeg', plot = plot.sim.abs,
       height = 9, units = 'in', dpi = "retina", bg = "white")

```

### Relative

```{r Relative}

# Easier to see/compare results with the differences rather than raw values
dat.long.temp = dat.long[!(dat.long$data.version %in% c('original', 'random', 'contiguous')), ]

ci95 = dat.long.temp |>
  dplyr::group_by(data.version, h.target, stride.intervals, drops) |>
  dplyr::summarise(h.mean = mean(h.value, na.rm = TRUE),
                   h.median = median(h.value, na.rm = TRUE),
                   .groups = "drop")

# Define line types that get more dashed with larger drops
linetypes = c("solid", "88", "66", "44", "22", "11")
linetype_map = setNames(rep(linetypes, length.out = length(unique(dat.long.temp$drops))),
                        sort(unique(dat.long.temp$drops)))

plot.sim.rel = ggplot(dat.long.temp, aes(x = h.value, fill = data.version)) +
  # Beautifying
  theme_classic() +
  scale_x_continuous(limits = c(-0.15, 0.15),
                     breaks = c(-0.15, -0.10, -0.05, 0, 0.05, 0.10, 0.15)) +
  # Raw data
  geom_density(alpha = 0.3, adjust = 1, show.legend = TRUE) +
  # Mean lines with varying dash intensity by drops
  geom_vline(data = ci95, aes(xintercept = h.mean,
                              color = data.version,
                              linetype = factor(drops)),
             linewidth = 0.6,
             show.legend = TRUE) +
  scale_linetype_manual(values = linetype_map,
                        name = "Dropped Data (%)") +
  # More beautifying
  scale_fill_manual(values = c("random.diff" = scales::alpha("#FA4616", 0.1),
                               "contiguous.diff" = scales::alpha("#0021A5", 0.1)),
                    name = "Data Version",
                    labels = c("Random", "Contiguous")) +
  scale_color_manual(values = c("random.diff" = "#FA4616",
                                "contiguous.diff" = "#0021A5"),
                     guide = "none") +
  labs(title = "Simulation",
       x = "Difference from Original Hurst Exponent (Dropped - Original)",
       y = "Density") +
  facet_grid(rows = vars(h.target),
             cols = vars(stride.intervals),
             labeller = labeller(h.target = function(x) paste0("H = ", x),
                                 stride.intervals = function(x) paste0(x, " Stride Intervals")),
             axes = "all_x") +
  theme(legend.position = "top",
        text = element_text(size = 9),
        axis.text.x = element_text(size = 7, angle = 30, hjust = 1),
        axis.text.y = element_text(size = 7),
        plot.title = element_text(hjust = 0.5, face = "bold", size = 15))

ggsave(filename = 'C:/Users/twiles/Downloads/sim_rel.jpeg', plot = plot.sim.rel,
       height = 9, units = 'in', dpi = "retina", bg = "white")

```

### Raw

```{r Raw}

# Only show the raw Data
dat.long.temp = dat.long[(dat.long$data.version %in% c('original', 'random', 'contiguous')), ]

ci95 = dat.long.temp |>
  dplyr::group_by(data.version, h.target, stride.intervals, drops) |>
  dplyr::summarise(h.mean = mean(h.value, na.rm = TRUE),
                   h.median = median(h.value, na.rm = TRUE),
                   .groups = "drop")

# Define line types that get more dashed with larger drops
linetypes = c("solid", "88", "66", "44", "22", "11")
linetype_map = setNames(rep(linetypes, length.out = length(unique(dat.long.temp$drops))),
                        sort(unique(dat.long.temp$drops)))

plot.sim.raw = ggplot(dat.long.temp, aes(x = h.value, fill = data.version)) +
  # Beautifying
  theme_classic() +
  scale_x_continuous(limits = c(0, 1),
                     breaks = c(seq(0,1,0.1))) +
  # Raw data
  geom_density(alpha = 0.3, adjust = 1, show.legend = TRUE) +
  # Mean lines with varying dash intensity by drops
  geom_vline(data = ci95, aes(xintercept = h.mean,
                              color = data.version,
                              linetype = factor(drops)),
             linewidth = 0.6,
             show.legend = TRUE) +
  scale_linetype_manual(values = linetype_map,
                        name = "Dropped Data (%)") +
  # More beautifying
  scale_fill_manual(values = c("original" = scales::alpha("black", 0.1),
                               "random" = scales::alpha("#FA4616", 0.1),
                               "contiguous" = scales::alpha("#0021A5", 0.1)),
                    name = "Data Version",
                    labels = c("Original", "Random", "Contiguous")) +
  scale_color_manual(values = c("original" = "black",
                                "random" = "#FA4616",
                                "contiguous" = "#0021A5"),
                     guide = "none") +
  labs(title = "Simulation",
       x = "Hurst Exponents",
       y = "Density") +
  facet_grid(rows = vars(h.target),
             cols = vars(stride.intervals),
             labeller = labeller(h.target = function(x) paste0("H = ", x),
                                 stride.intervals = function(x) paste0(x, " Stride Intervals")),
             axes = "all_x") +
  theme(legend.position = "top",
        text = element_text(size = 9),
        axis.text.x = element_text(size = 7, angle = 30, hjust = 1),
        axis.text.y = element_text(size = 7),
        plot.title = element_text(hjust = 0.5, face = "bold", size = 15))

ggsave(filename = 'C:/Users/twiles/Downloads/sim_raw.jpeg', plot = plot.sim.raw,
       height = 9, units = 'in', dpi = "retina", bg = "white")

```

# Empirical

## Gaitprint

Analysis of data obtained from Gaitprint

### Libraries and Data Management

```{r Libraries and Data Management}

options(scipen = 999)
rm(list=ls())

library(BayesFactor)
library(bayestestR)
library(data.table)
library(here)
library(ggplot2)
library(ggridges)

dat1 = data.table::fread(here::here('DATA', 'H_Simulation', 'H_Simulation_Gaitprint1.csv'))
dat2 = data.table::fread(here::here('DATA', 'H_Simulation', 'H_Simulation_Gaitprint2.csv'))
dat3 = data.table::fread(here::here('DATA', 'H_Simulation', 'H_Simulation_Gaitprint3.csv'))
dat = rbind(dat1, dat2, dat3)

setnames(dat, old = c('h.original', 'h.random', 'h.contiguous'),
         new = c('original', 'random', 'contiguous'))

dat$random.diff = dat$random - dat$original
dat$contiguous.diff = dat$contiguous - dat$original

dat.long = melt(dat,
                measure.vars = tail(names(dat), 5),
                variable.name = "data.version",
                value.name   = "h.value")

dat.long$drops = dat.long$drops * 100 # Change to percent

dat.long = dat.long[!is.nan(stride.intervals)] # Remove skipped trials

# Factors
dat.long$id = factor(dat.long$id)
# dat.long$stride.intervals = factor(dat.long$stride.intervals)
dat.long$drops = factor(dat.long$drops)
dat.long$stride.intervals.cut = factor(dat.long$stride.intervals.cut)
dat.long$stride.intervals.new.length = factor(dat.long$stride.intervals.new.length)
dat.long$data.version = factor(dat.long$data.version)

dat.long$h.value.abs = abs(dat.long$h.value)

```

### BFTests

Using Bayesian ttests, is H obtained from the dropped time series different from zero?

```{r BFTests}

# Easier to see/compare results with the differences rather than raw values
dat.long.temp = dat.long[!(dat.long$data.version %in% c('original', 'random', 'contiguous')), ]

bf.abs = dat.long.temp %>%
  group_by(stride.intervals, drops, data.version) %>%
  summarise(mu = mean(h.value.abs),
            ci.lower = bayestestR::ci(h.value.abs, method = 'hdi', ci = 0.95)$CI_low,
            ci.upper = bayestestR::ci(h.value.abs, method = 'hdi', ci = 0.95)$CI_high,
            BF10 = BayesFactor::extractBF(BayesFactor::ttestBF(x = h.value.abs, mu = 0))$bf,
            .groups = "drop")

bf.rel = dat.long.temp %>%
  group_by(stride.intervals, drops, data.version) %>%
  summarise(mu = mean(h.value),
            ci.lower = bayestestR::ci(h.value, method = 'hdi', ci = 0.95)$CI_low,
            ci.upper = bayestestR::ci(h.value, method = 'hdi', ci = 0.95)$CI_high,
            BF10 = BayesFactor::extractBF(BayesFactor::ttestBF(x = h.value, mu = 0))$bf,
            .groups = "drop")

# How many support the alternative?
table(bf.abs$BF10 > 1)
table(bf.rel$BF10 > 1)

```

### Plots

#### Absolute

```{r Absolute}

# Easier to see/compare results with the differences rather than raw values
dat.long.temp = dat.long[!(dat.long$data.version %in% c('original', 'random', 'contiguous')), ]

ci95 = dat.long.temp |>
  dplyr::group_by(data.version, stride.intervals, drops) |>
  dplyr::summarise(h.mean = mean(h.value.abs, na.rm = TRUE),
                   h.median = median(h.value.abs, na.rm = TRUE),
                   .groups = "drop")

# Define line types that get more dashed with larger drops
linetypes = c("solid", "88", "66", "44", "22", "11")
linetype_map = setNames(rep(linetypes, length.out = length(unique(dat.long.temp$drops))),
                        sort(unique(dat.long.temp$drops)))

plot.gaitprint.abs = ggplot(dat.long.temp, aes(x = h.value.abs, fill = data.version)) +
  # Beautifying
  theme_classic() +
  scale_x_continuous(limits = c(0, 0.15),
                     breaks = c(0, 0.05, 0.10, 0.15)) +
  # Raw data
  geom_density(alpha = 0.3, adjust = 1, show.legend = TRUE) +
  # Mean lines with varying dash intensity by drops
  geom_vline(data = ci95, aes(xintercept = h.mean,
                              color = data.version,
                              linetype = factor(drops)),
             linewidth = 0.6,
             show.legend = TRUE) +
  scale_linetype_manual(values = linetype_map,
                        name = "Dropped Data (%)") +
  # More beautifying
  scale_fill_manual(values = c("random.diff" = scales::alpha("#FA4616", 0.1),
                               "contiguous.diff" = scales::alpha("#0021A5", 0.1)),
                    name = "Data Version",
                    labels = c("Random", "Contiguous")) +
  scale_color_manual(values = c("random.diff" = "#FA4616",
                                "contiguous.diff" = "#0021A5"),
                     guide = "none") +
  labs(title = "Gaitprint",
       x = "Absolute Difference from Original Hurst Exponent (Dropped - Original)",
       y = "Density") +
  facet_grid(rows = vars(drops),
             cols = vars(stride.intervals),
             labeller = labeller(stride.intervals = function(x) paste0(x, " Stride Intervals"),
                                 drops = function(x) paste0(x, "% Dropped")),
             axes = "all_x") +
  theme(legend.position = "top",
        text = element_text(size = 9),
        axis.text.x = element_text(size = 7, angle = 30, hjust = 1),
        axis.text.y = element_text(size = 7),
        plot.title = element_text(hjust = 0.5, face = "bold", size = 15))

ggsave(filename = 'C:/Users/twiles/Downloads/gaitprint_abs.jpeg', plot = plot.gaitprint.abs,
       height = 9, units = 'in', dpi = "retina", bg = "white")

```

#### Relative

```{r Relative}

# Easier to see/compare results with the differences rather than raw values
dat.long.temp = dat.long[!(dat.long$data.version %in% c('original', 'random', 'contiguous')), ]

ci95 = dat.long.temp |>
  dplyr::group_by(data.version, stride.intervals, drops) |>
  dplyr::summarise(h.mean = mean(h.value, na.rm = TRUE),
                   h.median = median(h.value, na.rm = TRUE),
                   .groups = "drop")

# Define line types that get more dashed with larger drops
linetypes = c("solid", "88", "66", "44", "22", "11")
linetype_map = setNames(rep(linetypes, length.out = length(unique(dat.long.temp$drops))),
                        sort(unique(dat.long.temp$drops)))

plot.gaitprint.rel = ggplot(dat.long.temp, aes(x = h.value, fill = data.version)) +
  # Beautifying
  theme_classic() +
  scale_x_continuous(limits = c(-0.15, 0.15),
                     breaks = c(-0.15, -0.10, -0.05, 0, 0.05, 0.10, 0.15)) +
  # Raw data
  geom_density(alpha = 0.3, adjust = 1, show.legend = TRUE) +
  # Mean lines with varying dash intensity by drops
  geom_vline(data = ci95, aes(xintercept = h.mean,
                              color = data.version,
                              linetype = factor(drops)),
             linewidth = 0.6,
             show.legend = TRUE) +
  scale_linetype_manual(values = linetype_map,
                        name = "Dropped Data (%)") +
  # More beautifying
  scale_fill_manual(values = c("random.diff" = scales::alpha("#FA4616", 0.1),
                               "contiguous.diff" = scales::alpha("#0021A5", 0.1)),
                    name = "Data Version",
                    labels = c("Random", "Contiguous")) +
  scale_color_manual(values = c("random.diff" = "#FA4616",
                                "contiguous.diff" = "#0021A5"),
                     guide = "none") +
  labs(title = "Gaitprint",
       x = "Difference from Original Hurst Exponent (Dropped - Original)",
       y = "Density") +
  facet_grid(rows = vars(drops),
             cols = vars(stride.intervals),
             labeller = labeller(stride.intervals = function(x) paste0(x, " Stride Intervals"),
                                 drops = function(x) paste0(x, "% Dropped")),
             axes = "all_x") +
  theme(legend.position = "top",
        text = element_text(size = 9),
        axis.text.x = element_text(size = 7, angle = 30, hjust = 1),
        axis.text.y = element_text(size = 7),
        plot.title = element_text(hjust = 0.5, face = "bold", size = 15))

ggsave(filename = 'C:/Users/twiles/Downloads/gaitprint_rel.jpeg', plot = plot.gaitprint.rel,
       height = 9, units = 'in', dpi = "retina", bg = "white")

```

#### Raw

```{r Raw}

# Only show the raw Data
dat.long.temp = dat.long[(dat.long$data.version %in% c('original', 'random', 'contiguous')), ]

ci95 = dat.long.temp |>
  dplyr::group_by(data.version, stride.intervals, drops) |>
  dplyr::summarise(h.mean = mean(h.value.abs, na.rm = TRUE),
                   h.median = median(h.value.abs, na.rm = TRUE),
                   .groups = "drop")

# Define line types that get more dashed with larger drops
linetypes = c("solid", "88", "66", "44", "22", "11")
linetype_map = setNames(rep(linetypes, length.out = length(unique(dat.long.temp$drops))),
                        sort(unique(dat.long.temp$drops)))

plot.gaitprint.raw = ggplot(dat.long.temp, aes(x = h.value.abs, fill = data.version)) +
  # Beautifying
  theme_classic() +
  scale_x_continuous(limits = c(0, 1),
                     breaks = c(seq(0,1,0.1))) +
  # Raw data
  geom_density(alpha = 0.3, adjust = 1, show.legend = TRUE) +
  # Mean lines with varying dash intensity by drops
  geom_vline(data = ci95, aes(xintercept = h.mean,
                              color = data.version,
                              linetype = factor(drops)),
             linewidth = 0.6,
             show.legend = TRUE) +
  scale_linetype_manual(values = linetype_map,
                        name = "Dropped Data (%)") +
  # More beautifying
  scale_fill_manual(values = c("original" = scales::alpha("black", 0.1),
                               "random" = scales::alpha("#FA4616", 0.1),
                               "contiguous" = scales::alpha("#0021A5", 0.1)),
                    name = "Data Version",
                    labels = c("Original", "Random", "Contiguous")) +
  scale_color_manual(values = c("original" = "black",
                                "random" = "#FA4616",
                                "contiguous" = "#0021A5"),
                     guide = "none") +
  labs(title = "Gaitprint",
       x = "Hurst Exponent",
       y = "Density") +
  facet_grid(rows = vars(drops),
             cols = vars(stride.intervals),
             labeller = labeller(stride.intervals = function(x) paste0(x, " Stride Intervals"),
                                 drops = function(x) paste0(x, "% Dropped")),
             axes = "all_x") +
  theme(legend.position = "top",
        text = element_text(size = 9),
        axis.text.x = element_text(size = 7, angle = 30, hjust = 1),
        axis.text.y = element_text(size = 7),
        plot.title = element_text(hjust = 0.5, face = "bold", size = 15))

ggsave(filename = 'C:/Users/twiles/Downloads/gaitprint_raw.jpeg', plot = plot.gaitprint.raw,
       height = 9, units = 'in', dpi = "retina", bg = "white")

```

## MindinMotion

Analysis of data obtained from MindinMotion

### Libraries and Data Management

```{r Libraries and Data Management}

options(scipen = 999)
rm(list=ls())

library(BayesFactor)
library(bayestestR)
library(BayesFactor)
library(data.table)
library(dplyr)
library(here)
library(ggplot2)
library(ggridges)
library(readxl)

dat = data.table::fread(here::here('DATA', 'H_Simulation', 'H_Simulation_MIM.csv'))

# Only include trials that did not have to contain dropped data due to missing contacts
dat.ref = data.table::fread(here::here('DATA', 'H_Simulation', 'H_Simulation_MIM_Hypothesis.csv'))
dat.ref = dat.ref[dat.ref$n.intervals.dropped == 0]
dat.ref$id = apply(dat.ref[, 1:5], 1, function(row) paste(row, collapse = "_"))
dat = merge(dat, dat.ref[ ,1], by = c('id'), all = FALSE)

dat = dat[!is.nan(stride.intervals)] # Remove skipped trials

setnames(dat, old = c('h.original', 'h.random', 'h.contiguous'),
         new = c('original', 'random', 'contiguous'))

dat$random.diff = dat$random - dat$original
dat$contiguous.diff = dat$contiguous - dat$original

dat.long = melt(dat,
                measure.vars = tail(names(dat), 5),
                variable.name = "data.version",
                value.name   = "h.value")

dat.long$drops = dat.long$drops * 100 # Change to percent

dat.long = dat.long[!is.nan(stride.intervals)] # Remove skipped trials

# Factors
dat.long$id = factor(dat.long$id)
# dat.long$stride.intervals = factor(dat.long$stride.intervals)
dat.long$drops = factor(dat.long$drops)
dat.long$stride.intervals.cut = factor(dat.long$stride.intervals.cut)
dat.long$stride.intervals.new.length = factor(dat.long$stride.intervals.new.length)
dat.long$data.version = factor(dat.long$data.version)

dat.long$h.value.abs = abs(dat.long$h.value)

```

### BFTests

Using Bayesian ttests, is H obtained from the dropped time series different from zero?

```{r BFTests}

# Easier to see/compare results with the differences rather than raw values
dat.long.temp = dat.long[!(dat.long$data.version %in% c('original', 'random', 'contiguous')), ]

bf.abs = dat.long.temp %>%
  group_by(stride.intervals, drops, data.version) %>%
  summarise(mu = mean(h.value.abs),
            ci.lower = bayestestR::ci(h.value.abs, method = 'hdi', ci = 0.95)$CI_low,
            ci.upper = bayestestR::ci(h.value.abs, method = 'hdi', ci = 0.95)$CI_high,
            BF10 = BayesFactor::extractBF(BayesFactor::ttestBF(x = h.value.abs, mu = 0))$bf,
            .groups = "drop")

bf.rel = dat.long.temp %>%
  group_by(stride.intervals, drops, data.version) %>%
  summarise(mu = mean(h.value),
            ci.lower = bayestestR::ci(h.value, method = 'hdi', ci = 0.95)$CI_low,
            ci.upper = bayestestR::ci(h.value, method = 'hdi', ci = 0.95)$CI_high,
            BF10 = BayesFactor::extractBF(BayesFactor::ttestBF(x = h.value, mu = 0))$bf,
            .groups = "drop")

# How many support the alternative?
table(bf.abs$BF10 > 1)
table(bf.rel$BF10 > 1)

```

### Plots

#### Absolute

```{r Absolute}

# Easier to see/compare results with the differences rather than raw values
dat.long.temp = dat.long[!(dat.long$data.version %in% c('original', 'random', 'contiguous')), ]

ci95 = dat.long.temp |>
  dplyr::group_by(data.version, stride.intervals, drops) |>
  dplyr::summarise(h.mean = mean(h.value.abs, na.rm = TRUE),
                   h.median = median(h.value.abs, na.rm = TRUE),
                   .groups = "drop")

# Define line types that get more dashed with larger drops
linetypes = c("solid", "88", "66", "44", "22", "11")
linetype_map = setNames(rep(linetypes, length.out = length(unique(dat.long.temp$drops))),
                        sort(unique(dat.long.temp$drops)))

plot.mim.abs = ggplot(dat.long.temp, aes(x = h.value.abs, fill = data.version)) +
  # Beautifying
  theme_classic() +
  scale_x_continuous(limits = c(0, 0.15),
                     breaks = c(0, 0.05, 0.10, 0.15)) +
  # Raw data
  geom_density(alpha = 0.3, adjust = 1, show.legend = TRUE) +
  # Mean lines with varying dash intensity by drops
  geom_vline(data = ci95, aes(xintercept = h.mean,
                              color = data.version,
                              linetype = factor(drops)),
             linewidth = 0.6,
             show.legend = TRUE) +
  scale_linetype_manual(values = linetype_map,
                        name = "Dropped Data (%)") +
  # More beautifying
  scale_fill_manual(values = c("random.diff" = scales::alpha("#FA4616", 0.1),
                               "contiguous.diff" = scales::alpha("#0021A5", 0.1)),
                    name = "Data Version",
                    labels = c("Random", "Contiguous")) +
  scale_color_manual(values = c("random.diff" = "#FA4616",
                                "contiguous.diff" = "#0021A5"),
                     guide = "none") +
  labs(title = "MindinMotion",
       x = "Absolute Difference from Original Hurst Exponent (Dropped - Original)",
       y = "Density") +
  facet_grid(rows = vars(drops),
             cols = vars(stride.intervals),
             labeller = labeller(stride.intervals = function(x) paste0(x, " Stride Intervals"),
                                 drops = function(x) paste0(x, "% Dropped")),
             axes = "all_x") +
  theme(legend.position = "top",
        text = element_text(size = 9),
        axis.text.x = element_text(size = 7, angle = 30, hjust = 1),
        axis.text.y = element_text(size = 7),
        plot.title = element_text(hjust = 0.5, face = "bold", size = 15))

ggsave(filename = 'C:/Users/twiles/Downloads/mim_abs.jpeg', plot = plot.mim.abs,
       height = 9, units = 'in', dpi = "retina", bg = "white")

```

#### Relative

```{r Relative}

# Easier to see/compare results with the differences rather than raw values
dat.long.temp = dat.long[!(dat.long$data.version %in% c('original', 'random', 'contiguous')), ]

ci95 = dat.long.temp |>
  dplyr::group_by(data.version, stride.intervals, drops) |>
  dplyr::summarise(h.mean = mean(h.value, na.rm = TRUE),
                   h.median = median(h.value, na.rm = TRUE),
                   .groups = "drop")

# Define line types that get more dashed with larger drops
linetypes = c("solid", "88", "66", "44", "22", "11")
linetype_map = setNames(rep(linetypes, length.out = length(unique(dat.long.temp$drops))),
                        sort(unique(dat.long.temp$drops)))

plot.mim.rel = ggplot(dat.long.temp, aes(x = h.value, fill = data.version)) +
  # Beautifying
  theme_classic() +
  scale_x_continuous(limits = c(-0.15, 0.15),
                     breaks = c(-0.15, -0.10, -0.05, 0, 0.05, 0.10, 0.15)) +
  # Raw data
  geom_density(alpha = 0.3, adjust = 1, show.legend = TRUE) +
  # Mean lines with varying dash intensity by drops
  geom_vline(data = ci95, aes(xintercept = h.mean,
                              color = data.version,
                              linetype = factor(drops)),
             linewidth = 0.8,
             show.legend = TRUE) +
  scale_linetype_manual(values = linetype_map,
                        name = "Dropped Data (%)") +
  # More beautifying
  scale_fill_manual(values = c("random.diff" = scales::alpha("#FA4616", 0.1),
                               "contiguous.diff" = scales::alpha("#0021A5", 0.1)),
                    name = "Data Version",
                    labels = c("Random", "Contiguous")) +
  scale_color_manual(values = c("random.diff" = "#FA4616",
                                "contiguous.diff" = "#0021A5"),
                     guide = "none") +
  labs(title = "MindinMotion",
       x = "Difference from Original Hurst Exponent (Dropped - Original)",
       y = "Density") +
  facet_grid(rows = vars(drops),
             cols = vars(stride.intervals),
             labeller = labeller(stride.intervals = function(x) paste0(x, " Stride Intervals"),
                                 drops = function(x) paste0(x, "% Dropped")),
             axes = "all_x") +
  theme(legend.position = "top",
        text = element_text(size = 9),
        axis.text.x = element_text(size = 7, angle = 30, hjust = 1),
        axis.text.y = element_text(size = 7),
        plot.title = element_text(hjust = 0.5, face = "bold", size = 15))

ggsave(filename = 'C:/Users/twiles/Downloads/mim_rel.jpeg', plot = plot.mim.rel,
       height = 9, units = 'in', dpi = "retina", bg = "white")

```

#### Raw

```{r Raw}

# Only show the raw Data
dat.long.temp = dat.long[(dat.long$data.version %in% c('original', 'random', 'contiguous')), ]

ci95 = dat.long.temp |>
  dplyr::group_by(data.version, stride.intervals, drops) |>
  dplyr::summarise(h.mean = mean(h.value.abs, na.rm = TRUE),
                   h.median = median(h.value.abs, na.rm = TRUE),
                   .groups = "drop")

# Define line types that get more dashed with larger drops
linetypes = c("solid", "88", "66", "44", "22", "11")
linetype_map = setNames(rep(linetypes, length.out = length(unique(dat.long.temp$drops))),
                        sort(unique(dat.long.temp$drops)))

plot.mim.raw = ggplot(dat.long.temp, aes(x = h.value.abs, fill = data.version)) +
  # Beautifying
  theme_classic() +
  scale_x_continuous(limits = c(0, 1),
                     breaks = c(seq(0,1,0.1))) +
  # Raw data
  geom_density(alpha = 0.3, adjust = 1, show.legend = TRUE) +
  # Mean lines with varying dash intensity by drops
  geom_vline(data = ci95, aes(xintercept = h.mean,
                              color = data.version,
                              linetype = factor(drops)),
             linewidth = 0.6,
             show.legend = TRUE) +
  scale_linetype_manual(values = linetype_map,
                        name = "Dropped Data (%)") +
  # More beautifying
  scale_fill_manual(values = c("original" = scales::alpha("black", 0.1),
                               "random" = scales::alpha("#FA4616", 0.1),
                               "contiguous" = scales::alpha("#0021A5", 0.1)),
                    name = "Data Version",
                    labels = c("Original", "Random", "Contiguous")) +
  scale_color_manual(values = c("original" = "black",
                                "random" = "#FA4616",
                                "contiguous" = "#0021A5"),
                     guide = "none") +
  labs(title = "MindinMotion",
       x = "Hurst Exponent",
       y = "Density") +
  facet_grid(rows = vars(drops),
             cols = vars(stride.intervals),
             labeller = labeller(stride.intervals = function(x) paste0(x, " Stride Intervals"),
                                 drops = function(x) paste0(x, "% Dropped")),
             axes = "all_x") +
  theme(legend.position = "top",
        text = element_text(size = 9),
        axis.text.x = element_text(size = 7, angle = 30, hjust = 1),
        axis.text.y = element_text(size = 7),
        plot.title = element_text(hjust = 0.5, face = "bold", size = 15))

ggsave(filename = 'C:/Users/twiles/Downloads/mim_raw.jpeg', plot = plot.mim.raw,
       height = 9, units = 'in', dpi = "retina", bg = "white")

```

# MIM Hypothesis

Analysis of data obtained from MindinMotion

## Libraries and Data Management

```{r Libraries and Data Management}

options(scipen = 999)
rm(list=ls())

library(BayesFactor)
library(data.table)
library(dplyr)
library(here)
library(ggplot2)
library(ggridges)
library(readxl)

dat = data.table::fread(here::here('DATA', 'H_Simulation', 'H_Simulation_MIM_Hypothesis.csv'))
dat.demographics = as.data.table(read_excel(here("DATA", "MiM_Crunch_demographics_Chang.xlsx"), sheet = 2))
dat.demographics = dat.demographics[ ,c(3,6:13)] # Remove unwanted columns

# Merge
dat = merge(dat, dat.demographics, by.x = "id", by.y = "subject_code", all.x = TRUE)

# Remove skipped trials/NaNs
dat = dat[!(is.nan(dat$intervals.mean)), ]

# Cleanup
setnames(dat, old = c("Age", "Sex(1=M,0=F)", "Handedness (1=R, 2=L)", 
                      "terrain_trials_speed_ms", "Moca", "SPPB", 
                      "400_meters_seconds", "400m_speed"),
         new = c("age", "sex", "handedness", "terrain.speed", 
                 "moca", "sppb", "time.400m", "speed.400m"))
dat$handedness = ifelse(dat$handedness == 1, "right", "left")
dat$sex = ifelse(dat$sex == 1, "male", "female")
dat$speed = gsub("p", ".", dat$speed)

dat$functioning = ifelse(dat$sppb < 10, "low.functioning", "high.functioning") # Low functioning defined as sppb < 10
dat$group = ifelse(dat$age < 50, "young", "old") # young adults are less than 50 years old

# Only include older adults because we know differences are likely between young and older adults
dat = dat[dat$group == 'old']

# Factors
dat$id = factor(dat$id)
dat$treadmill = factor(dat$treadmill)
dat$speed = factor(dat$speed)
dat$terrain = factor(dat$terrain)
dat$trial = factor(dat$trial)
dat$sex = factor(dat$sex)
dat$handedness = factor(dat$handedness)
dat$functioning = factor(dat$functioning)
dat$group = factor(dat$group)
dat$n.intervals.dropped = factor(dat$n.intervals.dropped)
dat$pct.timeseries.dropped = factor(dat$pct.timeseries.dropped)

```

## BFTests

```{r BFTests}

# dat = dat[complete.cases(dat)]

# include people that did all speeds twice with complete cases
keeps = names(table(dat$id)[table(dat$id) == 8])
dat = dat[dat$id %in% keeps, ]
dat = dat[complete.cases(dat[ ,c(1,3,5:7,21)])]

# Differences in H between participant high/low functioning?
BayesFactor::anovaBF(hurst ~ speed * functioning + id, data = dat, whichRandom = 'id')
BayesFactor::ttestBF(x = dat$hurst[dat$speed == '0.25' & dat$functioning == 'high.functioning'],
                     y = dat$hurst[dat$speed == '0.25' & dat$functioning == 'low.functioning'],
                     paired = FALSE)
BayesFactor::ttestBF(x = dat$hurst[dat$speed == '0.5' & dat$functioning == 'high.functioning'],
                     y = dat$hurst[dat$speed == '0.5' & dat$functioning == 'low.functioning'],
                     paired = FALSE)
BayesFactor::ttestBF(x = dat$hurst[dat$speed == '0.75' & dat$functioning == 'high.functioning'],
                     y = dat$hurst[dat$speed == '0.75' & dat$functioning == 'low.functioning'],
                     paired = FALSE)
BayesFactor::ttestBF(x = dat$hurst[dat$speed == '1.0' & dat$functioning == 'high.functioning'],
                     y = dat$hurst[dat$speed == '1.0' & dat$functioning == 'low.functioning'],
                     paired = FALSE)

BayesFactor::ttestBF(x = dat$hurst[dat$speed == '0.25'],
                     y = dat$hurst[dat$speed == '0.5'],
                     paired = TRUE)
BayesFactor::ttestBF(x = dat$hurst[dat$speed == '0.25'],
                     y = dat$hurst[dat$speed == '0.75'],
                     paired = TRUE)
BayesFactor::ttestBF(x = dat$hurst[dat$speed == '0.25'],
                     y = dat$hurst[dat$speed == '1.0'],
                     paired = TRUE)
BayesFactor::ttestBF(x = dat$hurst[dat$speed == '0.5'],
                     y = dat$hurst[dat$speed == '0.75'],
                     paired = TRUE)
BayesFactor::ttestBF(x = dat$hurst[dat$speed == '0.5'],
                     y = dat$hurst[dat$speed == '1.0'],
                     paired = TRUE)
BayesFactor::ttestBF(x = dat$hurst[dat$speed == '0.75'],
                     y = dat$hurst[dat$speed == '1.0'],
                     paired = TRUE)

# For Sample Entropy?
BayesFactor::anovaBF(entropy ~ speed * functioning + id, data = dat, whichRandom = 'id')
BayesFactor::ttestBF(x = dat$entropy[dat$speed == '0.25' & dat$functioning == 'high.functioning'],
                     y = dat$entropy[dat$speed == '0.25' & dat$functioning == 'low.functioning'],
                     paired = FALSE)
BayesFactor::ttestBF(x = dat$entropy[dat$speed == '0.5' & dat$functioning == 'high.functioning'],
                     y = dat$entropy[dat$speed == '0.5' & dat$functioning == 'low.functioning'],
                     paired = FALSE)
BayesFactor::ttestBF(x = dat$entropy[dat$speed == '0.75' & dat$functioning == 'high.functioning'],
                     y = dat$entropy[dat$speed == '0.75' & dat$functioning == 'low.functioning'],
                     paired = FALSE)
BayesFactor::ttestBF(x = dat$entropy[dat$speed == '1.0' & dat$functioning == 'high.functioning'],
                     y = dat$entropy[dat$speed == '1.0' & dat$functioning == 'low.functioning'],
                     paired = FALSE)

BayesFactor::ttestBF(x = dat$entropy[dat$speed == '0.25'],
                     y = dat$entropy[dat$speed == '0.5'],
                     paired = TRUE)
BayesFactor::ttestBF(x = dat$entropy[dat$speed == '0.25'],
                     y = dat$entropy[dat$speed == '0.75'],
                     paired = TRUE)
BayesFactor::ttestBF(x = dat$entropy[dat$speed == '0.25'],
                     y = dat$entropy[dat$speed == '1.0'],
                     paired = TRUE)
BayesFactor::ttestBF(x = dat$entropy[dat$speed == '0.5'],
                     y = dat$entropy[dat$speed == '0.75'],
                     paired = TRUE)
BayesFactor::ttestBF(x = dat$entropy[dat$speed == '0.5'],
                     y = dat$entropy[dat$speed == '1.0'],
                     paired = TRUE)
BayesFactor::ttestBF(x = dat$entropy[dat$speed == '0.75'],
                     y = dat$entropy[dat$speed == '1.0'],
                     paired = TRUE)

```

## Plots

### Cognitive Function Differences

```{r Cognitive Function Differences}

ci95 = dat %>%
  dplyr::group_by(speed, functioning) %>%
  dplyr::summarise(hurst.mean = mean(hurst, na.rm = TRUE),
                   hurst.ci.lower = bayestestR::ci(hurst, method = 'hdi', ci = 0.95)$CI_low,
                   hurst.ci.upper = bayestestR::ci(hurst, method = 'hdi', ci = 0.95)$CI_high,
                   entropy.mean = mean(entropy, na.rm = TRUE),
                   entropy.ci.lower = bayestestR::ci(entropy, method = 'hdi', ci = 0.95)$CI_low,
                   entropy.ci.upper = bayestestR::ci(entropy, method = 'hdi', ci = 0.95)$CI_high,
                   .groups = "drop")

hursts = ggplot() +
  geom_point(data = dat, aes(x = speed,
                             y = hurst,
                             group = functioning),
             color = 'black', size = 1,
             position = position_jitterdodge(jitter.width = 0.15,
                                             dodge.width = 0.7)) +
  # colored lines connecting condition means
  geom_line(data = ci95, aes(x = speed,
                             y = hurst.mean,
                             color = functioning,
                             group = functioning),
            linewidth = 1.2, position = position_dodge(width = 0.7)) +
  # colored mean points
  geom_point(data = ci95, aes(x = speed,
                              y = hurst.mean,
                              color = functioning),
             size = 4, position = position_dodge(width = 0.7)) +
  # 95% credible intervals (HDI)
  geom_errorbar(data = ci95, aes(x = speed,
                                 ymin = hurst.ci.lower,
                                 ymax = hurst.ci.upper,
                                 color = functioning),
                width = 0.6, linewidth = 1, position = position_dodge(width = 0.7)) +
  # Beautify
  labs(x = "Speed (m/s)", y = "Hurst Exponent", color = 'Cognitive Function') +
  scale_color_manual(values = c("high.functioning" = "#D71920", "low.functioning" = "#2C3FDE"),
                     labels = c("High Functioning", "Low Functioning")) +
  theme_classic() +
  theme(legend.position = "top") +
  ylim(0, 1)
ggsave(filename = 'C:/Users/twiles/Downloads/MIM_SP_hursts_cog.jpeg', plot = hursts,
       dpi = "retina", bg = "white")

entropys = ggplot() +
  geom_point(data = dat, aes(x = speed,
                             y = entropy,
                             group = functioning),
             color = 'black', size = 1,
             position = position_jitterdodge(jitter.width = 0.15,
                                             dodge.width = 0.7)) +
  # colored lines connecting condition means
  geom_line(data = ci95, aes(x = speed,
                             y = entropy.mean,
                             color = functioning,
                             group = functioning),
            linewidth = 1.2, position = position_dodge(width = 0.7)) +
  # colored mean points
  geom_point(data = ci95, aes(x = speed,
                              y = entropy.mean,
                              color = functioning),
             size = 4, position = position_dodge(width = 0.7)) +
  # 95% credible intervals (HDI)
  geom_errorbar(data = ci95, aes(x = speed,
                                 ymin = entropy.ci.lower,
                                 ymax = entropy.ci.upper,
                                 color = functioning),
                width = 0.6, linewidth = 1, position = position_dodge(width = 0.7)) +
  # Beautify
  labs(x = "Speed (m/s)", y = "Sample Entropy", color = 'Cognitive Function') +
  scale_color_manual(values = c("high.functioning" = "#D71920", "low.functioning" = "#2C3FDE"),
                     labels = c("High Functioning", "Low Functioning")) +
  theme_classic() +
  theme(legend.position = "top")
ggsave(filename = 'C:/Users/twiles/Downloads/MIM_SP_entropys_cog.jpeg', plot = entropys,
       dpi = "retina", bg = "white")

```